<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.webapp.admin.mapper.AdminMtCodeMngrMapper">
	
	<!--  공통코드 신규삭제(박진만) -->
	<delete id="deleteMtCdAscInfo" parameterType="dmap">
		DELETE 
		  FROM TB_CMMN_ASCII_CODE 
		 WHERE CMMN_CODE_SN = #{cmmnCdSnDp}
	</delete>
	
	<!--  공통코드 수정(박진만) -->
	<update id="updateMtCdAscInfo" parameterType="dmap">
		UPDATE TB_CMMN_ASCII_CODE 
		
       	   SET CMMN_CODE_SN = #{cmmnCodeSn},
	           CMMN_CODE_NM = #{cmmnCodeNm},
	           CMMN_CODE_CN = #{cmmnCodeCn},
	           SYS_TY = #{sysTy},
	           UPPER_CMMN_CODE_SN = #{upperCmmnCodeSn},
	           INQIRE_ORDR = #{inqireOrdr},
	           USE_AT = #{useAt},
	           UPDT_DT = SYSDATE,
	           UPDT_USER_ID = #{sesUserId}
	           
 		 WHERE CMMN_CODE_SN = #{cmmnCdSnDp}
	</update>
	
	<!--  공통코드 신규등록(박진만) -->
	<insert id="insertMtCdAscInfo" parameterType="dmap">
		INSERT 
		  INTO TB_CMMN_ASCII_CODE
		       (      
		           CMMN_CODE_SN, 
		           CMMN_CODE_NM, 
		           CMMN_CODE_CN, 
		           CMMN_CODE_DP_NO,
		           SYS_TY,
		           UPPER_CMMN_CODE_SN,
		           INQIRE_ORDR,
		           USE_AT,
		           REGIST_DT,
		           REGIST_USER_ID
		       ) 
		       VALUES
		       (         
		           #{cmmnCodeSn},
		           #{cmmnCodeNm},
		           #{cmmnCodeCn},
		           #{cmmnCodeDpNo},
		           #{sysTy},
		           #{upperCmmnCodeSn},
		           #{inqireOrdr},
		           #{useAt},
		           SYSDATE,
		           #{sesUserId}
		       )
	</insert>
	
	<select id="cmmnCodeAsciiList3" parameterType="dmap" resultType="emap">
		SELECT 
		  <if test="cmmnCodeDpNo == 1">
		  CASE WHEN MAX(CMMN_CODE_SN) IS NOT NULL THEN
			TO_CHAR(MAX(CMMN_CODE_SN))
		  ELSE TO_CHAR(#{cmmnCodeSn} + 1000)
		  END AS CMMN_CODE_SN
 		  </if>
		  <if test="cmmnCodeDpNo == 2">
		  CASE WHEN MAX(CMMN_CODE_SN) IS NOT NULL THEN
			TO_CHAR(MAX(CMMN_CODE_SN))
		  ELSE TO_CHAR(#{cmmnCodeSn} + 10)
		  END AS CMMN_CODE_SN
 		  </if>
		  <if test="cmmnCodeDpNo == 3">
		  CASE WHEN MAX(CMMN_CODE_SN) IS NOT NULL THEN
			TO_CHAR(MAX(CMMN_CODE_SN))
		  ELSE TO_CHAR(#{cmmnCodeSn} + 1)
		  END AS CMMN_CODE_SN
 		  </if>
		  FROM TB_CMMN_ASCII_CODE 
		 WHERE UPPER_CMMN_CODE_SN = #{upperCmmnCodeSn}
	</select>
	
	<select id="mtCdDeleteChkCnt" parameterType="dmap" resultType="int">
		SELECT COUNT(1) 
		  FROM TB_CMMN_CODE 
		 WHERE UPPER_CMMN_CODE_SN = #{cmmnCdSnDp}
	</select>
	
	<!--  공통코드 신규등록(박진만) -->
	<insert id="insertMtCdInfo" parameterType="dmap">
		INSERT 
		  INTO TB_CMMN_CODE
		       (      
		           CMMN_CODE_SN, 
		           CMMN_CODE_NM, 
		           CMMN_CODE_CN, 
		           CMMN_CODE_DP_NO,
		           SYS_TY,
		           UPPER_CMMN_CODE_SN,
		           INQIRE_ORDR,
		           USE_AT,
		           REGIST_DT,
		           REGIST_USER_ID
		       ) 
		       VALUES
		       (         
		           #{cmmnCodeSn},
		           #{cmmnCodeNm},
		           #{cmmnCodeCn},
		           #{cmmnCodeDpNo},
		           #{sysTy},
		           #{upperCmmnCodeSn},
		           #{inqireOrdr},
		           #{useAt},
		           SYSDATE,
		           #{sesUserId}
		       )
	</insert>
	
	<!--  공통코드 수정(박진만) -->
	<update id="updateMtCdInfo" parameterType="dmap">
		UPDATE TB_CMMN_CODE 
		
       	   SET CMMN_CODE_SN = #{cmmnCodeSn},
	           CMMN_CODE_NM = #{cmmnCodeNm},
	           CMMN_CODE_CN = #{cmmnCodeCn},
	           SYS_TY = #{sysTy},
	           UPPER_CMMN_CODE_SN = #{upperCmmnCodeSn},
	           INQIRE_ORDR = #{inqireOrdr},
	           USE_AT = #{useAt},
	           UPDT_DT = SYSDATE,
	           UPDT_USER_ID = #{sesUserId}
	           
 		 WHERE CMMN_CODE_SN = #{cmmnCdSnDp}
	</update>
	
	<!--  공통코드 신규삭제(박진만) -->
	<delete id="deleteMtCdInfo" parameterType="dmap">
		DELETE 
		  FROM TB_CMMN_CODE 
		 WHERE CMMN_CODE_SN = #{cmmnCdSnDp}
	</delete>
	
	<!--  공통코드 번호 중복확인(박진만) -->
	<select id="cmmnCodeDoubleChk" parameterType="dmap" resultType="int">
		SELECT COUNT(1) 
		  FROM TB_CMMN_CODE 
	  	 WHERE CMMN_CODE_SN = #{cmmnCodeSn}
	</select>
	
	<!-- 공통코드 중복가능할 때 중복확인 -->
	<!-- <select id="cmmnCodeDoubleChk" parameterType="dmap" resultType="int">
	SELECT SUM(DEP_FULL_NM_CNT) 
	  FROM (SELECT COUNT(LTRIM (SYS_CONNECT_BY_PATH (CMMN_CODE_SN, '>'), '>')) AS DEP_FULL_NM_CNT 
  		  FROM TB_CMMN_CODE 
 		 <if test="cmmnCodeSn != null and cmmnCodeSn != ''">
 		  	WHERE CMMN_CODE_SN = #{cmmnCodeSn}
 		  </if>
 		 START WITH UPPER_CMMN_CODE_SN = 
       		(SELECT SUBSTR(C.DEP_FULL_NM,0,(INSTR(C.DEP_FULL_NM,'>','1','1'))-1) AS NAME 
         	   FROM (
         	   		SELECT LTRIM (SYS_CONNECT_BY_PATH (CMMN_CODE_SN, '>'), '>') AS DEP_FULL_NM, 
                    	   ROWNUM AS RO 
                	  FROM TB_CMMN_CODE 
               		 <if test="upperCmmnCodeSn != null and upperCmmnCodeSn != ''">
			 		  	WHERE CMMN_CODE_SN = #{upperCmmnCodeSn}
			 		 </if>
               		 START WITH UPPER_CMMN_CODE_SN = 'MAIN' CONNECT BY PRIOR CMMN_CODE_SN = UPPER_CMMN_CODE_SN
                 	) C 
           	  WHERE RO = 1
          	) CONNECT BY PRIOR CMMN_CODE_SN = UPPER_CMMN_CODE_SN
          	UNION
          	SELECT COUNT(CMMN_CODE_SN) DEP_FULL_NM_CNT FROM TB_CMMN_CODE WHERE CMMN_CODE_DP_NO IN('0','1')
          	<if test="cmmnCodeSn != null and cmmnCodeSn != ''">
 		  		AND CMMN_CODE_SN = #{cmmnCodeSn}
 		  	</if>
          	)
	</select> -->
	
	<!--  공통코드 아스키 트리 리스트 조회(박진만) -->
	<select id="cmmnCodeAsciiList" parameterType="dmap" resultType="map">
		SELECT 
		   ROWNUM AS Ro, 
	       CMMN_CODE_SN, 
	       CMMN_CODE_NM, 
	       CMMN_CODE_CN, 
	       CMMN_CODE_DP_NO,
	       SYS_TY,
	       NVL(UPPER_CMMN_CODE_SN, '-') AS UPPER_CMMN_CODE_SN,
	       INQIRE_ORDR,
	       USE_AT,
	       REGIST_DT,
	       REGIST_USER_ID,
	       UPDT_DT,
	       UPDT_USER_ID
 		FROM TB_CMMN_ASCII_CODE
 		WHERE 1=1
 		  <if test="cmmnCodeDpNo != null and cmmnCodeDpNo != ''">
 		  	AND CMMN_CODE_DP_NO = #{cmmnCodeDpNo}
 		  </if>
		ORDER BY CMMN_CODE_DP_NO, UPPER_CMMN_CODE_SN, INQIRE_ORDR, CMMN_CODE_SN
	</select>
	
	<!--  공통코드 아스키 트리 리스트 조회(박진만) -->
	<select id="cmmnCodeAsciiList2" parameterType="dmap" resultType="emap">
		SELECT 
		   ROWNUM AS Ro, 
	       CMMN_CODE_SN, 
	       CMMN_CODE_NM, 
	       CMMN_CODE_CN, 
	       CMMN_CODE_DP_NO,
	       SYS_TY,
	       UPPER_CMMN_CODE_SN,
	       INQIRE_ORDR,
	       USE_AT,
	       REGIST_DT,
	       REGIST_USER_ID,
	       UPDT_DT,
	       UPDT_USER_ID
 		FROM TB_CMMN_ASCII_CODE
 		WHERE 1=1
 		  <if test="cmmnCodeSn != null and cmmnCodeSn != ''">
 		  	AND CMMN_CODE_SN = #{cmmnCodeSn}
 		  </if>
		ORDER BY CMMN_CODE_DP_NO, INQIRE_ORDR, CMMN_CODE_SN
	</select>
	
	<!--  공통코드 트리 리스트 조회(박진만) -->
	<select id="cmmnCodeTreeList" parameterType="dmap" resultType="emap">
		SELECT 
		   ROWNUM AS Ro, 
	       CMMN_CODE_SN, 
	       CMMN_CODE_NM, 
	       CMMN_CODE_CN, 
	       CMMN_CODE_DP_NO,
	       SYS_TY,
	       UPPER_CMMN_CODE_SN,
	       INQIRE_ORDR,
	       USE_AT,
	       REGIST_DT,
	       REGIST_USER_ID,
	       UPDT_DT,
	       UPDT_USER_ID
 		FROM TB_CMMN_CODE
 		WHERE 1=1
 		  <if test="cmmnCodeSn != null and cmmnCodeSn != ''">
 		  	AND CMMN_CODE_SN = #{cmmnCodeSn}
 		  </if>
		ORDER BY CMMN_CODE_DP_NO, INQIRE_ORDR, CMMN_CODE_SN
	</select>
	
	<!--  공통코드 트리 리스트 조회2(박진만) -->
	<select id="cmmnCodeTreeList2" parameterType="dmap" resultType="map">
		SELECT 
		   ROWNUM AS Ro, 
	       CMMN_CODE_SN, 
	       CMMN_CODE_NM, 
	       CMMN_CODE_CN, 
	       CMMN_CODE_DP_NO,
	       SYS_TY,
	       NVL(UPPER_CMMN_CODE_SN, '-') AS UPPER_CMMN_CODE_SN,
	       INQIRE_ORDR,
	       USE_AT,
	       REGIST_DT,
	       REGIST_USER_ID,
	       UPDT_DT,
	       UPDT_USER_ID
 		FROM TB_CMMN_CODE
 		WHERE 1=1
 		  <if test="cmmnCodeDpNo != null and cmmnCodeDpNo != ''">
 		  	AND CMMN_CODE_DP_NO = #{cmmnCodeDpNo}
 		  </if>
		ORDER BY CMMN_CODE_DP_NO, UPPER_CMMN_CODE_SN, INQIRE_ORDR, CMMN_CODE_SN
	</select>
	
	<!--  공통코드 트리 리스트 조회2(박진만) -->
	<select id="cmmnCodeTreeListTotalCnt" parameterType="dmap" resultType="int">
		SELECT 
	       COUNT(CMMN_CODE_SN) 
 		FROM TB_CMMN_CODE
 		WHERE 1=1
 		  <if test="cmmnCodeDpNo != null and cmmnCodeDpNo != ''">
 		  	AND CMMN_CODE_DP_NO = #{cmmnCodeDpNo}
 		  </if>
	</select>

    <!-- 대분류 목록조회 -->
    <select id="getMtcodeList" parameterType="dmap" resultType="emap">
    	SELECT AA.*
        FROM  (
	        SELECT
	            ROW_NUMBER() OVER(ORDER BY MT_CODE, MT_NAME ASC) AS NUM
	            , MT_CODE
	            , MT_NAME
	            , NVL(CID, '') AS CID
	            , USEYN
	            , USE_GB
	            , DECODE(USE_GB, 'S', '시스템', 'U', '업무', '-') AS USE_GB_NAME
	            , ETC
	        FROM TB_CD_MT
	        WHERE 1=1
	        <if test="useYn != null and useYn != ''">
	            AND USEYN = #{useYn}
	        </if>
	        <if test="useGb != null and useGb != ''">
	            AND USE_GB = #{useGb}
	        </if>
	        <if test="searchWord != null and searchWord != ''">
				<if test="searchMode != null and searchMode == 'mtCode'">
	              	AND MT_CODE LIKE '%'||#{searchWord}||'%'
	            </if>
	            <if test="searchMode != null and searchMode == 'mtName'">
	                AND MT_NAME LIKE '%'||#{searchWord}||'%'
	            </if>
	         </if>
	    ) AA
	    WHERE 1=1
        <if test="startNo != null and startNo != '0'"> 
	         AND NUM BETWEEN #{startNo} AND #{endNo}
	    </if>
    </select>

    <!-- 대분류 목록조회 count -->
    <select id="getMtcodeListCount" parameterType="dmap" resultType="int">
         SELECT COUNT (*) total FROM TB_CD_MT
         WHERE 1=1

         <if test="useYn != null and useYn != ''">
            AND USEYN = #{useYn}
        </if>
        <if test="useGb != null and useGb != ''">
            AND USE_GB = #{useGb}
        </if>
        <if test="searchWord != null and searchWord != ''">
			<if test="searchMode != null and searchMode == 'mtCode'">
              	AND MT_CODE LIKE '%'||#{searchWord}||'%'
            </if>
            <if test="searchMode != null and searchMode == 'mtName'">
                AND MT_NAME LIKE '%'||#{searchWord}||'%'
            </if>
         </if>

    </select>

    <!-- 대분류 정보 조회 -->
    <select id="getMtcodInfo" parameterType="dmap" resultType="emap">
        SELECT
            MT_NAME
            , MT_CODE
            , CID
            , USEYN
            , USE_GB
            , DECODE(USE_GB, 'S', '시스템', 'U', '업무', '-') AS USE_GB_NAME
            , ETC
        FROM TB_CD_MT 
         WHERE 1=1
        <if test = "mtCode != null and mtCode != ''">
        	AND MT_CODE = #{mtCode}
        </if>
    </select>

    <!-- 대분류 등록  -->
    <insert id="insertMtcodeInfo" parameterType="dmap">
        INSERT INTO TB_CD_MT (
            MT_CODE
            , MT_NAME
            , CID
            , USEYN
            , USE_GB
            , ETC )
        VALUES (
            #{mtCode}
            , #{mtName}
            , #{cid}
            , #{useYn}
            , #{useGb}
            , #{etc})
    </insert>

    <!-- 대분류 수정 -->
    <update id="updateMtcodeInfo" parameterType="dmap">
        UPDATE TB_CD_MT SET
            MT_NAME = #{mtName}
            , CID = #{cid}
            , USEYN = #{useYn}
            , USE_GB = #{useGb}
            , ETC = #{etc}
        WHERE MT_CODE = #{mtCode}
    </update>

    <!-- 소분류 목록조회 -->
    <select id="getMtcodeSubList" parameterType="dmap" resultType="emap">
        SELECT
            MT_SUB_CODE
            , MT_CODE
            , MT_SUB_NAME
            , NUM_CD
            , ABC_CD
            , USEYN
            , ORDR
            , SUMMARY
        FROM TB_CD_MT_SUB
        WHERE MT_CODE = #{mtCode}
        ORDER BY ORDR, MT_SUB_CODE, MT_SUB_NAME ASC
    </select>

    <!-- 소분류 정보 조회 -->
    <select id="getMtcodeSubInfo" parameterType="dmap" resultType="emap">
        SELECT
            MT_SUB_CODE
            , MT_CODE
            , MT_SUB_NAME
            , NVL(NUM_CD, '0') AS "NUM_CD"
            , NVL(ABC_CD, null) AS "ABC_CD"
            , USEYN
            , ORDR
            , SUMMARY
        FROM TB_CD_MT_SUB
        WHERE MT_CODE= #{mtCode}
        <if test = "mtSubCode != null and mtSubCode != ''">
        	AND MT_SUB_CODE = #{mtSubCode}
        </if> 
    </select>

    <!-- 소분류 등록  -->
    <insert id="insertMtcodeSubInfo" parameterType="dmap">
        INSERT INTO TB_CD_MT_SUB (
            MT_SUB_CODE
            , MT_CODE
            , MT_SUB_NAME
            , NUM_CD
            , ABC_CD
            , USEYN
            , SUMMARY
            , ORDR 
        )
        VALUES (
            #{mtSubCode}
            , #{mtCode}
            , #{mtSubName}
            , #{numCd}
            , #{abcCd}
            , #{useYn}
            , #{summary}
            , #{ordr}
        )
    </insert>

    <!-- 소분류 수정 -->
    <update id="updateMtcodeSubInfo" parameterType="dmap">
        UPDATE TB_CD_MT_SUB
            SET MT_SUB_NAME = #{mtSubName}
                , NUM_CD = #{numCd}
                , ABC_CD =#{abcCd}
                , USEYN = #{useYn}
                , SUMMARY = #{summary}
            	, ORDR = #{ordr}
        WHERE MT_CODE = #{mtCode}
        AND   MT_SUB_CODE=#{mtSubCode}
    </update>

    <!-- 소분류 삭제 -->
    <delete id="deleteMtcodeSubInfo" parameterType="dmap">
        DELETE FROM TB_CD_MT_SUB
        WHERE MT_CODE=#{mtCode} AND MT_SUB_CODE=#{mtSubCode}
    </delete>


</mapper>